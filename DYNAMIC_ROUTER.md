# åŠ¨æ€è·¯ç”±æ›´æ–°ç³»ç»Ÿ

Claude Code Router ç°åœ¨æ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡å³å¯åº”ç”¨é…ç½®æ›´æ”¹ã€‚

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½

### âœ… é›¶åœæœºé…ç½®æ›´æ–°
- **æ–‡ä»¶ç›‘å¬**: è‡ªåŠ¨æ£€æµ‹ `config.json` å’Œè‡ªå®šä¹‰è·¯ç”±æ–‡ä»¶çš„å˜åŒ–
- **çƒ­é‡è½½**: é…ç½®æ›´æ”¹åæ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆ
- **æ™ºèƒ½éªŒè¯**: æ–°é…ç½®åœ¨åº”ç”¨å‰ä¼šè¿›è¡Œå®Œæ•´æ€§éªŒè¯
- **è‡ªåŠ¨å›æ»š**: å½“æ–°é…ç½®æœ‰é—®é¢˜æ—¶è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªå¯ç”¨ç‰ˆæœ¬

### ğŸ”„ ç‰ˆæœ¬ç®¡ç†
- **ç‰ˆæœ¬å†å²**: è‡ªåŠ¨ä¿å­˜æœ€è¿‘10ä¸ªé…ç½®ç‰ˆæœ¬
- **æ‰‹åŠ¨å›æ»š**: æ”¯æŒå›æ»šåˆ°ä»»æ„å†å²ç‰ˆæœ¬
- **å˜æ›´è¿½è¸ª**: è¯¦ç»†çš„é…ç½®å˜æ›´è®°å½•å’Œå·®å¼‚å¯¹æ¯”
- **å¤‡ä»½æœºåˆ¶**: æ¯æ¬¡æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½å½“å‰é…ç½®

### ğŸ›¡ï¸ å®‰å…¨éªŒè¯
- **å¤šå±‚éªŒè¯**: 
  - é…ç½®æ–‡ä»¶æ ¼å¼éªŒè¯
  - æä¾›å•†è¿æ¥æ€§æµ‹è¯•
  - è·¯ç”±è§„åˆ™å®Œæ•´æ€§æ£€æŸ¥
  - å®‰å…¨æ€§é…ç½®å®¡æ ¸
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ¢å¤æœºåˆ¶
- **å¥åº·æ£€æŸ¥**: å®æ—¶ç›‘æ§æä¾›å•†çŠ¶æ€

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡
```bash
ccr start
```

æœåŠ¡å¯åŠ¨åï¼ŒåŠ¨æ€è·¯ç”±å™¨ä¼šè‡ªåŠ¨åˆå§‹åŒ–å¹¶å¼€å§‹ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–ã€‚

### 2. éªŒè¯åŠ¨æ€è·¯ç”±å™¨çŠ¶æ€
```bash
curl -H "Authorization: Bearer your-secret-key" \
     http://localhost:3456/api/config/status
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": {
    "isActive": true,
    "currentVersion": "v1",
    "lastUpdate": 1642694400000,
    "hotReloadEnabled": true,
    "health": "healthy",
    "errorCount": 0
  },
  "version": {
    "id": "v1-1642694400000",
    "version": "v1",
    "timestamp": 1642694400000,
    "isActive": true
  },
  "hotReloadEnabled": true
}
```

## ğŸ“¡ API ç«¯ç‚¹

### é…ç½®ç®¡ç†

#### `GET /api/config/status`
è·å–åŠ¨æ€è·¯ç”±å™¨å½“å‰çŠ¶æ€
- **æƒé™**: éœ€è¦ API å¯†é’¥
- **è¿”å›**: è·¯ç”±å™¨çŠ¶æ€ã€å½“å‰ç‰ˆæœ¬ä¿¡æ¯

#### `POST /api/config/hot-reload`
æ‰‹åŠ¨è§¦å‘é…ç½®é‡è½½
- **æƒé™**: éœ€è¦å®Œå…¨è®¿é—®æƒé™
- **è¿”å›**: é‡è½½ç»“æœå’Œæ–°ç‰ˆæœ¬ä¿¡æ¯

#### `POST /api/config/validate`
éªŒè¯é…ç½®æœ‰æ•ˆæ€§ï¼ˆä¸åº”ç”¨ï¼‰
- **æƒé™**: éœ€è¦å®Œå…¨è®¿é—®æƒé™
- **è¯·æ±‚ä½“**: é…ç½®JSONå¯¹è±¡
- **è¿”å›**: è¯¦ç»†çš„éªŒè¯ç»“æœ

### ç‰ˆæœ¬ç®¡ç†

#### `GET /api/config/versions`
è·å–é…ç½®ç‰ˆæœ¬å†å²
- **æƒé™**: éœ€è¦ API å¯†é’¥
- **è¿”å›**: ç‰ˆæœ¬åˆ—è¡¨å’Œå…ƒæ•°æ®

#### `POST /api/config/rollback`
å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
- **æƒé™**: éœ€è¦å®Œå…¨è®¿é—®æƒé™
- **è¯·æ±‚ä½“**: `{ "versionId": "ç‰ˆæœ¬ID" }`
- **è¿”å›**: å›æ»šæ“ä½œç»“æœ

#### `GET /api/config/diff/:fromVersion/:toVersion`
è·å–ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚
- **æƒé™**: éœ€è¦ API å¯†é’¥
- **å‚æ•°**: æºç‰ˆæœ¬IDå’Œç›®æ ‡ç‰ˆæœ¬ID
- **è¿”å›**: è¯¦ç»†çš„é…ç½®å·®å¼‚

## ğŸ”§ é…ç½®ç¤ºä¾‹

### åŸºç¡€é…ç½®æ›´æ–°
ç›´æ¥ç¼–è¾‘ `~/.claude-code-router/config.json`ï¼š

```json
{
  "Providers": [
    {
      "name": "openrouter",
      "api_base_url": "https://openrouter.ai/api/v1/chat/completions",
      "api_key": "sk-your-key",
      "models": ["anthropic/claude-3.5-sonnet"]
    }
  ],
  "Router": {
    "default": "openrouter,anthropic/claude-3.5-sonnet"
  }
}
```

ä¿å­˜åï¼ŒåŠ¨æ€è·¯ç”±å™¨ä¼šåœ¨500mså†…è‡ªåŠ¨æ£€æµ‹å˜åŒ–å¹¶åº”ç”¨æ›´æ–°ã€‚

### ä½¿ç”¨ API æ›´æ–°é…ç½®

```bash
curl -X POST \
     -H "Authorization: Bearer your-secret-key" \
     -H "Content-Type: application/json" \
     -d @new-config.json \
     http://localhost:3456/api/config
```

### è‡ªå®šä¹‰è·¯ç”±æ–‡ä»¶
å¦‚æœä½¿ç”¨è‡ªå®šä¹‰è·¯ç”±æ–‡ä»¶ï¼Œå®ƒä¹Ÿæ”¯æŒçƒ­é‡è½½ï¼š

```javascript
// custom-router.js
module.exports = function(req, config) {
  // æ‚¨çš„è‡ªå®šä¹‰è·¯ç”±é€»è¾‘
  if (req.body.messages.length > 10) {
    return "openrouter,anthropic/claude-3.5-sonnet";
  }
  return config.Router.default;
};
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### äº‹ä»¶æ—¥å¿—
åŠ¨æ€è·¯ç”±å™¨ä¼šè®°å½•ä»¥ä¸‹äº‹ä»¶ï¼š
- é…ç½®æ–‡ä»¶å˜åŒ–æ£€æµ‹
- é…ç½®éªŒè¯ç»“æœ  
- ç‰ˆæœ¬åˆ›å»ºå’Œåˆ‡æ¢
- é”™è¯¯å’Œå›æ»šæ“ä½œ

### å¥åº·æ£€æŸ¥
ç³»ç»Ÿä¼šå®šæœŸæ£€æŸ¥ï¼š
- æä¾›å•†è¿æ¥çŠ¶æ€
- é…ç½®æ–‡ä»¶å®Œæ•´æ€§
- è·¯ç”±è§„åˆ™æœ‰æ•ˆæ€§
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## ğŸ› ï¸ æµ‹è¯•å·¥å…·

é¡¹ç›®æä¾›äº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬ï¼š

```bash
node examples/dynamic-router-test.js
```

æµ‹è¯•è„šæœ¬ä¼šéªŒè¯ï¼š
- âœ… è·¯ç”±å™¨çŠ¶æ€æŸ¥è¯¢
- âœ… é…ç½®éªŒè¯åŠŸèƒ½
- âœ… æ‰‹åŠ¨çƒ­é‡è½½
- âœ… ç‰ˆæœ¬å†å²ç®¡ç†
- âœ… è‡ªåŠ¨æ–‡ä»¶ç›‘å¬

## âš¡ æ€§èƒ½ä¼˜åŒ–

### æ–‡ä»¶ç›‘å¬ä¼˜åŒ–
- **é˜²æŠ–æœºåˆ¶**: 500mså†…å¤šæ¬¡å˜æ›´åªè§¦å‘ä¸€æ¬¡æ›´æ–°
- **æ ¡éªŒå’Œæ£€æŸ¥**: åªæœ‰å†…å®¹çœŸæ­£æ”¹å˜æ‰è§¦å‘æ›´æ–°
- **å¼‚æ­¥å¤„ç†**: æ–‡ä»¶å˜åŒ–å¤„ç†ä¸é˜»å¡è¯·æ±‚å¤„ç†

### å†…å­˜ç®¡ç†
- **ç‰ˆæœ¬é™åˆ¶**: æœ€å¤šä¿å­˜10ä¸ªå†å²ç‰ˆæœ¬
- **è‡ªåŠ¨æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡æœŸçš„å¤‡ä»½å’Œæ—¥å¿—
- **æ‡’åŠ è½½**: æŒ‰éœ€åŠ è½½é…ç½®éªŒè¯å’Œç‰ˆæœ¬ç®¡ç†åŠŸèƒ½

## ğŸ”’ å®‰å…¨è€ƒè™‘

### è®¿é—®æ§åˆ¶
- **API å¯†é’¥éªŒè¯**: æ‰€æœ‰é…ç½®ç›¸å…³APIéœ€è¦æœ‰æ•ˆå¯†é’¥
- **æƒé™åˆ†çº§**: åªæœ‰å®Œå…¨è®¿é—®æƒé™å¯ä»¥ä¿®æ”¹é…ç½®
- **é…ç½®åŠ å¯†**: æ•æ„Ÿé…ç½®é¡¹è‡ªåŠ¨åŠ å¯†å­˜å‚¨

### è¾“å…¥éªŒè¯  
- **æ¶æ„éªŒè¯**: ä¸¥æ ¼çš„JSONæ¶æ„æ£€æŸ¥
- **å†…å®¹è¿‡æ»¤**: é˜²æ­¢æ¶æ„é…ç½®æ³¨å…¥
- **æ–‡ä»¶æƒé™**: ç¡®ä¿é…ç½®æ–‡ä»¶è®¿é—®å®‰å…¨

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### åŠ¨æ€è·¯ç”±å™¨æœªå¯åŠ¨
**ç—‡çŠ¶**: APIè¿”å›è·¯ç”±å™¨æœªåˆå§‹åŒ–é”™è¯¯
**è§£å†³**: æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®

#### é…ç½®éªŒè¯å¤±è´¥
**ç—‡çŠ¶**: é…ç½®æ›´æ–°è¢«æ‹’ç»
**è§£å†³**: ä½¿ç”¨ `/api/config/validate` ç«¯ç‚¹æ£€æŸ¥å…·ä½“é”™è¯¯

#### è‡ªåŠ¨é‡è½½ä¸å·¥ä½œ
**ç—‡çŠ¶**: æ–‡ä»¶ä¿®æ”¹åé…ç½®æœªæ›´æ–°
**è§£å†³**: æ£€æŸ¥æ–‡ä»¶æƒé™å’Œè·¯å¾„æ˜¯å¦æ­£ç¡®

#### æä¾›å•†è¿æ¥å¤±è´¥
**ç—‡çŠ¶**: å¥åº·æ£€æŸ¥æ˜¾ç¤ºæä¾›å•†ä¸å¯ç”¨
**è§£å†³**: éªŒè¯APIå¯†é’¥å’Œç½‘ç»œè¿æ¥

### è°ƒè¯•æ¨¡å¼
å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼š
```bash
DEBUG=claude-code-router:* ccr start
```

### é…ç½®é‡ç½®
å¦‚æœé…ç½®å®Œå…¨æŸåï¼Œå¯ä»¥åˆ é™¤é…ç½®æ–‡ä»¶é‡æ–°åˆå§‹åŒ–ï¼š
```bash
rm ~/.claude-code-router/config.json
ccr start
```

## ğŸ“ˆ é«˜çº§ç”¨æ³•

### æ‰¹é‡é…ç½®æ›´æ–°
```bash
# å¤‡ä»½å½“å‰é…ç½®
curl -H "Authorization: Bearer your-key" \
     http://localhost:3456/api/config > backup.json

# åº”ç”¨æ–°é…ç½®
curl -X POST \
     -H "Authorization: Bearer your-key" \
     -H "Content-Type: application/json" \
     -d @batch-config.json \
     http://localhost:3456/api/config

# å¦‚æœ‰é—®é¢˜ç«‹å³å›æ»š
curl -X POST \
     -H "Authorization: Bearer your-key" \
     -H "Content-Type: application/json" \
     -d '{"versionId": "previous-version-id"}' \
     http://localhost:3456/api/config/rollback
```

### è‡ªåŠ¨åŒ–è„šæœ¬é›†æˆ
```bash
#!/bin/bash
# update-config.sh
CONFIG_FILE="$HOME/.claude-code-router/config.json"
BACKUP_FILE="$CONFIG_FILE.backup.$(date +%s)"

# å¤‡ä»½å½“å‰é…ç½®
cp "$CONFIG_FILE" "$BACKUP_FILE"

# æ›´æ–°é…ç½®
cat > "$CONFIG_FILE" << 'EOF'
{
  "Providers": [...],
  "Router": {...}
}
EOF

# éªŒè¯æ›´æ–°ç»“æœ
sleep 2
if curl -f -H "Authorization: Bearer $API_KEY" \
        "http://localhost:3456/api/config/status" > /dev/null 2>&1; then
    echo "é…ç½®æ›´æ–°æˆåŠŸ"
    rm "$BACKUP_FILE"
else
    echo "é…ç½®æ›´æ–°å¤±è´¥ï¼Œæ­£åœ¨å›æ»š..."
    mv "$BACKUP_FILE" "$CONFIG_FILE"
fi
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®æ”¹è¿›å»ºè®®ï¼è¯·æŸ¥çœ‹ä»¥ä¸‹æ–‡ä»¶äº†è§£æ¶æ„è¯¦æƒ…ï¼š

- `src/utils/configWatcher.ts` - æ–‡ä»¶ç›‘å¬å®ç°
- `src/utils/configValidator.ts` - é…ç½®éªŒè¯é€»è¾‘  
- `src/utils/configVersionManager.ts` - ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½
- `src/utils/dynamicRouter.ts` - åŠ¨æ€è·¯ç”±æ ¸å¿ƒ
- `src/utils/providerManager.ts` - æä¾›å•†ç®¡ç†

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦æƒ…è¯·å‚é˜… [LICENSE](LICENSE) æ–‡ä»¶ã€‚